### Restart simulation ###
## Elastique biaxial compression of granular media ###
    
## Beginning of simulation
    timestep     1E-5 # simulation time step

   ## Computation ##

    # Neighbor computation
    compute      voisin all contact/atom # compute number of neighbor  at d = dmin of the center of each grains
    compute      moy_voisin all reduce ave c_voisin # mean of the neighbor over all the grains
    
    # Stress of the system 
    compute      sigma_comp all stress/atom NULL virial # computation of the stress tensor componenent for each atoms
    compute      moy_sigma_comp all reduce sum c_sigma_comp[*] # sum the stress tensor over every atoms
    
    # Grains movement
    compute      u_comp all displace/atom
    compute      u_moy_comp all reduce ave c_u_comp[*][*]
    
    # Temperature
    compute      temp_ela_comp all temp/sphere
    
## Variable ##

    variable     A_ini equal 0.1
    variable     A equal ${A_ini}
     
    # follow the stress state of the system
    variable     sigma_comp_xx equal c_moy_sigma_comp[1]
    variable     sigma_comp_yy equal c_moy_sigma_comp[2]
    variable     sigma_comp_xy equal c_moy_sigma_comp[4]
    variable     p_comp equal "(c_moy_sigma_comp[1]+ c_moy_sigma_comp[2])/2"
    #variable     p_comp equal "(v_sigma_comp_xx + v_sigma_comp_yy)/2"
    
## Stress control loop ## 

    if           "${p_comp} > 4010" then "$A = ${A_ini} / 2" & 
    elif         "${p_comp} < 3090" "$A = ${A_ini} * 2" &
    else         "$A = ${A_ini}" # control the pressure applied, if its to large or to small, reduce or increase the displacement  

## Output command ##

    # actualise the values 
    print        "compute sigma xx = c_moy_sigma[1]"
    print        "compute sigma yy = c_moy_sigma[2]"
    #print        "sigma xx = ${sigma_comp_xx}"
    #print        "sigma yy = ${sigma_comp_yy}"
    print        "p = ${p_comp}"
    
    thermo       1000 # output every 1 000 step of time
    thermo_style custom step atoms c_temp_ela_comp c_moy_voisin &
                 density press c_u_moy_comp[1] c_u_moy_comp[2] &
                 lx ly &
                 v_sigma_comp_xx  v_sigma_comp_yy v_sigma_comp_xy &
                 v_p_comp
    
    #dump		 comp_ela_img all image 100000 comp_ela.*.jpg type type &
    #             zoom 1.6 adiam 4.0
    #dump_modify	 comp_ela_img pad 5
    
	#dump         compression all movie 500 compression.avi type type &
    #             zoom 1.6 adiam 4.0 # create a video of the compression
	#dump_modify  compression pad 5
    
## Stress control test ##

    fix          sur_amortissement all viscous 2.0 # viscous damping
    fix          temp_cste all temp/berendsen 300.0 300.0 100 # define a constant temperature for the simulation
    
    fix          ela_comp all deform 1 x wiggle $A 0.1 &
                                       y wiggle $A 0.1 &
                                       units box  
    
    fix          calcul_v_m all nve/sphere disc # temporal integration of grains
    
    fix          2Dsimu all enforce2d # ensure 2D simulation by zeroing strenght/speed in z direction 

## End of elastic compression ##

	run	         50000 #  50 000 step of simulation 
    
### End of elastic compression step ###