### Biaxial compression of granular media ###
   
   	## Computation ## 
   
   		# Beginning of the simulation
   		variable 	DT equal 1E-4 # discretization time 
   		timestep     	${DT} # simulation time step = DT

   	 	# Stress of the system 
   	 	compute     	sigma_comp all stress/atom NULL virial # computation of the stress tensor componenent for each atoms
   	 	compute      	moy_sigma_comp all reduce sum c_sigma_comp[*] # sum the stress tensor over every atoms
        
   	 	# Neighbor computation
   	 	compute      	voisin all coord/atom cutoff ${CUTOFF} # compute number of neighbor  at d = dmin of the center of each grains
   	 	compute      	moy_voisin all reduce ave c_voisin # mean of the neighbor over all the grains
   	 
   	 	# Grains movement
   	 	compute      	u_comp all displace/atom
   	 	compute      	u_moy_comp all reduce ave c_u_comp[*][*]
    
   	 	# Temperature 
   	 	compute      	temperature all temp/sphere
    
	## Variable ##
    
	    	variable     	STEP_COMP equal 445000 # number of step of simulation
	    	variable     	COMP equal -1E-2
	    	#variable_S_GRAINS#
	    	variable 	LX equal lx
	    	variable 	LY equal ly
	    	variable 	PHI equal "v_S_GRAINS / (v_LX*v_LY)"
	    	variable     	PHI_MIN equal "v_PHI_AIMED - 1"
	    	variable     	PHI_MAX equal "v_PHI_AIMED + 1"
	    	variable     	P equal "(c_moy_sigma_comp[1] + c_moy_sigma_comp[2])/2"
	    	variable     	S_XX equal c_moy_sigma_comp[1]
	    	variable     	S_YY equal c_moy_sigma_comp[2]
	    	variable     	S_XY equal c_moy_sigma_comp[4]
      
	## Fix for biaxial compression ##
	
	     	fix          	comp all deform 100 &
				x erate ${COMP} &
				y erate ${COMP} &
				units box remap v  
		fix          	calcul_v_m all nve/sphere disc #  compute the velocity of the atoms and the angular momentum for every sphere    
	     	fix          	2Dsimu all enforce2d # ensure 2D simulation by zeroing strenght/speed in z direction

	## Output commmand ##
    
    		thermo      	5000 # output every 5000 time step
    		thermo_style 	custom step atoms c_temperature c_moy_voisin &
    			        v_PHI press c_u_moy_comp[1] c_u_moy_comp[2] &
				lx ly &
                               v_S_XX  v_S_YY v_S_XY &
                               v_P
                                                 
		dump	    	compression_img all image 100000 compression.*.jpg type type &
        	         	zoom 1.6 adiam 1.5
    		dump_modify	compression_img pad 5
    
		#dump         	compression all movie 500 compression.avi type type &
    		#		zoom 1.6 adiam 1.5 # create a video of the compression step
		#dump_modify  	compression pad 5

	## End of compression ##

    		run          	${STEP_COMP} 
    
    		print 		"--------------------------- PHI = ${PHI} ----------------------------"
    		print 		"--------------------------- PHI_AIMED = ${PHI_AIMED} ------------------------------------"     
    		if 		"${PHI} < ${PHI_MIN} || ${PHI} > ${PHI_MAX}" then "quit"
                      
### End of compression step ###
